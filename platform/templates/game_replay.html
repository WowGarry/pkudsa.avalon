{% extends "base.html" %}
{% block title %}
  对局重放 - {{ game_id }}
{% endblock title %}
{% block content %}
  <div class="container mt-4">
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">对局详情 - {{ game_id }}</h4>
            <span class="badge bg-light text-dark">{{ game_info.start_time }}</span>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h5>基本信息</h5>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    玩家数量
                    <span class="badge bg-primary rounded-pill">{{ game_info.player_count }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    地图大小
                    <span class="badge bg-primary rounded-pill">{{ game_info.map_size }}x{{ game_info.map_size }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    进行回合
                    <span class="badge bg-primary rounded-pill">{{ game_info.rounds_played }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    比赛结果
                    <span class="badge {% if game_info.winner == 'blue' %}bg-info{% else %}bg-danger{% endif %} rounded-pill">
                      {{ "蓝方胜利" if game_info.winner == "blue" else "红方胜利" }}
                    </span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    胜利原因
                    <span class="badge bg-secondary rounded-pill">
                      {{ "任务完成" if game_info.win_reason == "missions_completed" else "任务失败" if game_info.win_reason == "missions_failed" else "刺杀成功" if game_info.win_reason == "assassination_success" else game_info.win_reason }}
                    </span>
                  </li>
                </ul>
              </div>
              <div class="col-md-6">
                <h5>角色分配</h5>
                <div class="table-responsive">
                  <table class="table table-bordered table-sm">
                    <thead class="table-light">
                      <tr>
                        <th>玩家ID</th>
                        <th>角色</th>
                        <th>阵营</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for player_id, role in game_info.roles.items() %}
                        <tr>
                          <td>{{ player_id }}</td>
                          <td>
                            {% if role == "Merlin" %}
                              梅林
                            {% elif role == "Percival" %}
                              派西维尔
                            {% elif role == "Knight" %}
                              骑士
                            {% elif role == "Assassin" %}
                              刺客
                            {% elif role == "Morgana" %}
                              莫甘娜
                            {% elif role == "Mordred" %}
                              莫德雷德
                            {% elif role == "Oberon" %}
                              奥伯伦
                            {% else %}
                              {{ role }}
                            {% endif %}
                          </td>
                          <td>
                            {% if role in ["Merlin", "Percival", "Knight"] %}
                              <span class="badge bg-info">蓝方</span>
                            {% else %}
                              <span class="badge bg-danger">红方</span>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 任务回合记录 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-success text-white">
            <h4 class="mb-0">任务进程</h4>
          </div>
          <div class="card-body">
            <div class="progress mb-4" style="height: 30px;">
              {% for i in range(1, 6) %}
                {% if i <= game_info.blue_wins %}
                  <div class="progress-bar bg-info"
                       role="progressbar"
                       style="width: 20%"
                       aria-valuenow="20"
                       aria-valuemin="0"
                       aria-valuemax="100">任务{{ i }}：成功</div>
                {% elif i <= game_info.blue_wins + game_info.red_wins %}
                  <div class="progress-bar bg-danger"
                       role="progressbar"
                       style="width: 20%"
                       aria-valuenow="20"
                       aria-valuemin="0"
                       aria-valuemax="100">任务{{ i }}：失败</div>
                {% else %}
                  <div class="progress-bar bg-secondary"
                       role="progressbar"
                       style="width: 20%"
                       aria-valuenow="20"
                       aria-valuemin="0"
                       aria-valuemax="100">任务{{ i }}：未进行</div>
                {% endif %}
              {% endfor %}
            </div>
            <!-- 任务详情手风琴 -->
            <div class="accordion" id="missionAccordion">
              {% for event in game_events %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading{{ event.round }}">
                    <button class="accordion-button {% if loop.index > 1 %}collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ event.round }}"
                            aria-expanded="{{ 'true' if loop.index == 1 else 'false' }}"
                            aria-controls="collapse{{ event.round }}">
                      第{{ event.round }}轮任务 -
                      {% if event.mission_result %}
                        {% if event.mission_result.result == "success" %}
                          <span class="badge bg-info ms-2">成功</span>
                        {% else %}
                          <span class="badge bg-danger ms-2">失败</span>
                        {% endif %}
                      {% else %}
                        <span class="badge bg-secondary ms-2">未完成</span>
                      {% endif %}
                    </button>
                  </h2>
                  <div id="collapse{{ event.round }}"
                       class="accordion-collapse collapse {{ 'show' if loop.index == 1 else '' }}"
                       aria-labelledby="heading{{ event.round }}"
                       data-bs-parent="#missionAccordion">
                    <div class="accordion-body">
                      <!-- 队长和团队 -->
                      <div class="mb-3">
                        <h5>队长与队员</h5>
                        <p>队长：{{ event.leader }} 号玩家</p>
                        <p>
                          队员：
                          {% for member in event.team_members %}
                            {{ member }}
                            {% if not loop.last %},{% endif %}
                          {% endfor %}
                        </p>
                      </div>
                      <!-- 全局发言 -->
                      <div class="mb-3">
                        <h5>全局发言</h5>
                        <div class="table-responsive">
                          <table class="table table-striped table-sm">
                            <thead>
                              <tr>
                                <th>玩家</th>
                                <th>发言内容</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for speech in event.speeches %}
                                <tr>
                                  <td>
                                    {% set player_id = speech[0] %}
                                    {% set player_role = game_info.roles.get(player_id|string, "") %}
                                    {{ player_id }} 号玩家
                                    {% if game_info.roles %}
                                      <span class="badge {% if player_role in ['Merlin', 'Percival', 'Knight'] %}bg-info{% else %}bg-danger{% endif %} rounded-pill">
                                        {% if player_role == "Merlin" %}
                                          梅林
                                        {% elif player_role == "Percival" %}
                                          派西维尔
                                        {% elif player_role == "Knight" %}
                                          骑士
                                        {% elif player_role == "Assassin" %}
                                          刺客
                                        {% elif player_role == "Morgana" %}
                                          莫甘娜
                                        {% elif player_role == "Mordred" %}
                                          莫德雷德
                                        {% elif player_role == "Oberon" %}
                                          奥伯伦
                                        {% else %}
                                          {{ player_role }}
                                        {% endif %}
                                      </span>
                                    {% endif %}
                                  </td>
                                  <td>{{ speech[1] }}</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                      <!-- 公投结果 -->
                      {% if event.vote_result %}
                        <div class="mb-3">
                          <h5>公投结果</h5>
                          <p>
                            结果：
                            {% if event.vote_result.result == "approved" %}
                              <span class="badge bg-success">通过</span>
                            {% else %}
                              <span class="badge bg-warning">拒绝</span>
                            {% endif %}
                            (赞成: {{ event.vote_result.approve_count }})
                          </p>
                          <div class="table-responsive">
                            <table class="table table-sm">
                              <thead>
                                <tr>
                                  <th>玩家</th>
                                  <th>投票</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for player_id, vote in event.vote_result.votes.items() %}
                                  <tr>
                                    <td>
                                      {% set player_role = game_info.roles.get(player_id, "") %}
                                      {{ player_id }} 号玩家
                                      {% if game_info.roles %}
                                        <span class="badge {% if player_role in ['Merlin', 'Percival', 'Knight'] %}bg-info{% else %}bg-danger{% endif %} rounded-pill">
                                          {% if player_role == "Merlin" %}
                                            梅林
                                          {% elif player_role == "Percival" %}
                                            派西维尔
                                          {% elif player_role == "Knight" %}
                                            骑士
                                          {% elif player_role == "Assassin" %}
                                            刺客
                                          {% elif player_role == "Morgana" %}
                                            莫甘娜
                                          {% elif player_role == "Mordred" %}
                                            莫德雷德
                                          {% elif player_role == "Oberon" %}
                                            奥伯伦
                                          {% else %}
                                            {{ player_role }}
                                          {% endif %}
                                        </span>
                                      {% endif %}
                                    </td>
                                    <td>
                                      {% if vote %}
                                        <span class="badge bg-success">赞成</span>
                                      {% else %}
                                        <span class="badge bg-danger">反对</span>
                                      {% endif %}
                                    </td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      {% endif %}
                      <!-- 任务执行结果 -->
                      {% if event.mission_execution %}
                        <div class="mb-3">
                          <h5>任务执行结果</h5>
                          <p>
                            结果：
                            {% if event.mission_execution.success %}
                              <span class="badge bg-info">成功</span>
                            {% else %}
                              <span class="badge bg-danger">失败</span> (失败票: {{ event.mission_execution.fail_votes }})
                            {% endif %}
                          </p>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
