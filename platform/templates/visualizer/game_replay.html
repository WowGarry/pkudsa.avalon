{% extends "base.html" %}
{% block title %}
  对局重放 - {{ game_id }}
{% endblock title %}
{% block styles %}
  {{ super() }}
  <style>
    .game-map {
      display: grid;
      grid-template-columns: repeat({{ map_size }}, 1fr);
      grid-template-rows: repeat({{ map_size }}, 1fr);
      gap: 2px;
      background-color: #f5f5f5;
      padding: 8px;
      border-radius: 8px;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .map-cell {
      aspect-ratio: 1;
      background-color: #fff;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      font-weight: bold;
    }
    
    .player-token {
      width: 80%;
      height: 80%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .player-blue {
      background-color: #007bff;
    }
    
    .player-red {
      background-color: #dc3545;
    }
    
    .player-unknown {
      background-color: #6c757d;
    }
    
    .timeline-item {
      position: relative;
      padding-left: 30px;
      margin-bottom: 15px;
    }
    
    .timeline-item:before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: #dee2e6;
    }
    
    .timeline-dot {
      position: absolute;
      left: 4px;
      top: 10px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background-color: #007bff;
    }
    
    .map-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .tooltip-icon {
      margin-left: 5px;
      cursor: help;
    }
    
    .role-icon {
      width: 24px;
      height: 24px;
      margin-right: 5px;
    }
    
    .player-movement-path {
      stroke-dasharray: 5;
      stroke-width: 2;
      fill: none;
    }
    
    .player-history-position {
      opacity: 0.3;
    }
  </style>
{% endblock styles %}
{% block content %}
  <div class="container-fluid mt-4">
    <div class="row">
      <!-- 左侧：游戏信息 -->
      <div class="col-md-4">
        <!-- 游戏基本信息卡片 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">对局信息</h4>
            <span class="badge bg-light text-dark">{{ game_info.start_time_formatted }}</span>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-12">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    游戏ID
                    <span class="badge bg-secondary">{{ game_id }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    玩家数量
                    <span class="badge bg-primary rounded-pill">{{ game_info.player_count }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    地图大小
                    <span class="badge bg-primary rounded-pill">{{ game_info.map_size }}x{{ game_info.map_size }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    进行回合
                    <span class="badge bg-primary rounded-pill">{{ game_info.rounds_played }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    比赛时长
                    <span class="badge bg-primary rounded-pill">{{ game_info.duration }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    比赛结果
                    <span class="badge {% if game_info.winner == 'blue' %}bg-info{% else %}bg-danger{% endif %} rounded-pill">
                      {{ "蓝方胜利" if game_info.winner == "blue" else "红方胜利" }}
                    </span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    胜利原因
                    <span class="badge bg-secondary rounded-pill">
                      {% if game_info.win_reason == "missions_completed" %}
                        任务完成
                      {% elif game_info.win_reason == "missions_failed" %}
                        任务失败
                      {% elif game_info.win_reason == "assassination_success" %}
                        刺杀成功
                      {% elif game_info.win_reason == "assassination_failed" %}
                        刺杀失败
                      {% else %}
                        {{ game_info.win_reason }}
                      {% endif %}
                    </span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <!-- 角色信息卡片 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-dark text-white">
            <h5 class="mb-0">角色分配</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-bordered table-sm mb-0">
                <thead class="table-light">
                  <tr>
                    <th>玩家ID</th>
                    <th>角色</th>
                    <th>阵营</th>
                  </tr>
                </thead>
                <tbody>
                  {% for player_id, role in game_info.roles.items() %}
                    <tr>
                      <td>{{ player_id }}</td>
                      <td>
                        {% if role == "Merlin" %}
                          <span class="text-primary">梅林</span>
                        {% elif role == "Percival" %}
                          <span class="text-primary">派西维尔</span>
                        {% elif role == "Knight" %}
                          <span class="text-primary">骑士</span>
                        {% elif role == "Assassin" %}
                          <span class="text-danger">刺客</span>
                        {% elif role == "Morgana" %}
                          <span class="text-danger">莫甘娜</span>
                        {% elif role == "Mordred" %}
                          <span class="text-danger">莫德雷德</span>
                        {% elif role == "Oberon" %}
                          <span class="text-danger">奥伯伦</span>
                        {% else %}
                          {{ role }}
                        {% endif %}
                      </td>
                      <td>
                        {% if role in ["Merlin", "Percival", "Knight"] %}
                          <span class="badge bg-info">蓝方</span>
                        {% else %}
                          <span class="badge bg-danger">红方</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- 中间：游戏地图和时间轴 -->
      <div class="col-md-4">
        <!-- 游戏地图卡片 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">游戏地图</h5>
          </div>
          <div class="card-body">
            <div class="map-controls">
              <div class="btn-group" role="group">
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        id="prevRoundBtn">
                  <i class="bi bi-chevron-left"></i> 上一轮
                </button>
                <select class="form-select form-select-sm"
                        id="roundSelector"
                        style="width: 120px">
                  <option value="0">初始状态</option>
                  {% for event in game_events %}<option value="{{ event.round }}">第{{ event.round }}轮</option>{% endfor %}
                </select>
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        id="nextRoundBtn">
                  下一轮 <i class="bi bi-chevron-right"></i>
                </button>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showMovementTrails">
                <label class="form-check-label" for="showMovementTrails">显示移动轨迹</label>
              </div>
            </div>
            <div class="game-map" id="gameMap">
              <!-- 地图将由JS动态生成 -->
            </div>
            <div class="mt-3">
              <p class="text-center mb-1">
                当前回合：<span id="currentRound">初始状态</span>
              </p>
              <p class="text-center text-muted">点击玩家查看详情</p>
            </div>
          </div>
        </div>
        <!-- 任务进度卡片 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">任务进度</h5>
          </div>
          <div class="card-body">
            <div class="progress mb-3" style="height: 30px;">
              {% for i in range(1, 6) %}
                {% if i <= game_info.blue_wins %}
                  <div class="progress-bar bg-info"
                       role="progressbar"
                       style="width: 20%"
                       aria-valuenow="20"
                       aria-valuemin="0"
                       aria-valuemax="100">任务{{ i }}：成功</div>
                {% elif i <= game_info.blue_wins + game_info.red_wins %}
                  <div class="progress-bar bg-danger"
                       role="progressbar"
                       style="width: 20%"
                       aria-valuenow="20"
                       aria-valuemin="0"
                       aria-valuemax="100">任务{{ i }}：失败</div>
                {% else %}
                  <div class="progress-bar bg-secondary"
                       role="progressbar"
                       style="width: 20%"
                       aria-valuenow="20"
                       aria-valuemin="0"
                       aria-valuemax="100">任务{{ i }}：未进行</div>
                {% endif %}
              {% endfor %}
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>回合</th>
                    <th>队长</th>
                    <th>队员</th>
                    <th>任务结果</th>
                  </tr>
                </thead>
                <tbody>
                  {% for event in game_events %}
                    <tr>
                      <td>{{ event.round }}</td>
                      <td>
                        {% if event.leader %}
                          {{ event.leader }}号
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if event.team_members %}
                          {% for member in event.team_members %}
                            <span class="badge {% if game_info.roles.get(member|string) in ['Merlin', 'Percival', 'Knight'] %}bg-info{% else %}bg-danger{% endif %}">
                              {{ member }}
                            </span>
                          {% endfor %}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if event.mission_result %}
                          {% if event.mission_result.result == "success" %}
                            <span class="badge bg-info">成功</span>
                          {% else %}
                            <span class="badge bg-danger">失败</span>
                            {% if event.mission_execution.fail_votes %}({{ event.mission_execution.fail_votes }}票){% endif %}
                          {% endif %}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- 右侧：回合详细信息 -->
      <div class="col-md-4">
        <!-- 回合详情卡片 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
              回合详情 <span id="roundDetailTitle">（选择回合查看）</span>
            </h5>
          </div>
          <div class="card-body" id="roundDetailContent">
            <div class="text-center py-5">
              <p class="text-muted">请选择一个回合查看详细信息</p>
            </div>
          </div>
        </div>
        <!-- 玩家聊天记录卡片 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">发言记录</h5>
          </div>
          <div class="card-body p-0">
            <ul class="list-group list-group-flush" id="chatMessages">
              <li class="list-group-item text-center text-muted">选择回合查看该轮发言记录</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- 玩家详情模态框 -->
    <div class="modal fade"
         id="playerDetailModal"
         tabindex="-1"
         aria-labelledby="playerDetailModalLabel"
         aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="playerDetailModalLabel">玩家详情</h5>
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="关闭"></button>
          </div>
          <div class="modal-body" id="playerDetailContent">
            <!-- 玩家详情将在JS中填充 -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 玩家角色名称映射
      const roleNames = {
        'Merlin': '梅林',
        'Percival': '派西维尔',
        'Knight': '骑士',
        'Assassin': '刺客',
        'Morgana': '莫甘娜',
        'Mordred': '莫德雷德',
        'Oberon': '奥伯伦'
      };
      
      // 玩家阵营映射
      const roleFactions = {
        'Merlin': 'blue',
        'Percival': 'blue',
        'Knight': 'blue',
        'Assassin': 'red',
        'Morgana': 'red',
        'Mordred': 'red',
        'Oberon': 'red'
      };
      
      // 生成初始地图
      const mapSize = {{ map_size }};
      const gameMap = document.getElementById('gameMap');
      const roles = {{ game_info.roles|tojson }};
      
      // 创建地图单元格
      for (let x = 0; x < mapSize; x++) {
        for (let y = 0; y < mapSize; y++) {
          const cell = document.createElement('div');
          cell.className = 'map-cell';
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.dataset.coordinates = `${x},${y}`;
          gameMap.appendChild(cell);
        }
      }
      
      // 玩家移动数据
      const playerMovements = {{ player_movements|tojson }};
      
      // 游戏事件数据
      const gameEvents = {{ game_events|tojson }};
      
      // 当前显示的回合
      let currentRound = 0;
      
      // 更新地图显示
      function updateMap(round) {
        // 清除所有玩家标记
        document.querySelectorAll('.player-token').forEach(token => token.remove());
        document.querySelectorAll('.player-path').forEach(path => path.remove());
        
        // 显示该回合的玩家位置
        for (const playerId in playerMovements) {
          const movements = playerMovements[playerId];
          const playerRoundMovements = movements.filter(m => m.round <= round);
          
          if (playerRoundMovements.length > 0) {
            // 获取当前回合的位置
            const currentPosition = playerRoundMovements[playerRoundMovements.length - 1].position;
            const [x, y] = currentPosition;
            
            // 在地图上标记玩家
            const cell = document.querySelector(`.map-cell[data-coordinates="${x},${y}"]`);
            if (cell) {
              const playerRole = roles[playerId];
              const faction = roleFactions[playerRole] || 'unknown';
              
              const token = document.createElement('div');
              token.className = `player-token player-${faction}`;
              token.textContent = playerId;
              token.dataset.playerId = playerId;
              token.title = `${playerId}号玩家 - ${roleNames[playerRole] || playerRole || '未知角色'}`;
              
              // 添加点击事件显示玩家详情
              token.addEventListener('click', () => showPlayerDetail(playerId));
              
              cell.appendChild(token);
            }
            
            // 如果开启了轨迹显示，显示移动历史
            const showTrails = document.getElementById('showMovementTrails').checked;
            if (showTrails && playerRoundMovements.length > 1) {
              // 显示历史位置（半透明标记）
              for (let i = 0; i < playerRoundMovements.length - 1; i++) {
                const [hx, hy] = playerRoundMovements[i].position;
                const historyCell = document.querySelector(`.map-cell[data-coordinates="${hx},${hy}"]`);
                if (historyCell) {
                  const historyToken = document.createElement('div');
                  historyToken.className = `player-token player-${faction} player-history-position`;
                  historyToken.textContent = playerId;
                  historyToken.title = `${playerId}号玩家 - 第${playerRoundMovements[i].round}轮位置`;
                  historyCell.appendChild(historyToken);
                }
              }
            }
          }
        }
        
        // 更新当前回合显示
        document.getElementById('currentRound').textContent = round === 0 ? '初始状态' : `第${round}轮`;
        document.getElementById('roundSelector').value = round;
        
        // 如果选择了非初始回合，加载该回合的详细信息
        if (round > 0) {
          loadRoundDetails(round);
        } else {
          // 显示初始状态的提示
          document.getElementById('roundDetailContent').innerHTML = `
            <div class="text-center py-5">
              <p class="text-muted">游戏初始状态</p>
              <p class="text-muted">角色已分配，夜晚阶段完成</p>
            </div>
          `;
          document.getElementById('roundDetailTitle').textContent = '（初始状态）';
          document.getElementById('chatMessages').innerHTML = `
            <li class="list-group-item text-center text-muted">
              游戏初始阶段没有发言记录
            </li>
          `;
        }
      }
      
      // 加载回合详细信息
      function loadRoundDetails(round) {
        // 查找该回合的事件数据
        const roundEvent = gameEvents.find(event => event.round === parseInt(round));
        if (!roundEvent) {
          document.getElementById('roundDetailContent').innerHTML = `
            <div class="text-center py-5">
              <p class="text-muted">未找到第${round}轮的详细信息</p>
            </div>
          `;
          document.getElementById('roundDetailTitle').textContent = `（第${round}轮）`;
          return;
        }
        
        // 更新标题
        document.getElementById('roundDetailTitle').textContent = `（第${round}轮）`;
        
        // 构建回合详情HTML
        let detailsHtml = `
          <div class="mb-3">
            <h6>队长</h6>
            <p>
              ${roundEvent.leader}号玩家
              <span class="badge ${roles[roundEvent.leader] && roleFactions[roles[roundEvent.leader]] === 'blue' ? 'bg-info' : 'bg-danger'}">
                ${roleNames[roles[roundEvent.leader]] || roles[roundEvent.leader] || '未知角色'}
              </span>
            </p>
          </div>
          
          <div class="mb-3">
            <h6>队员选择</h6>
            <p>
              ${roundEvent.team_members.map(id => `
                <span class="badge ${roles[id] && roleFactions[roles[id]] === 'blue' ? 'bg-info' : 'bg-danger'}">
                  ${id}号 - ${roleNames[roles[id]] || roles[id] || '未知角色'}
                </span>
              `).join(' ')}
            </p>
          </div>
        `;
        
        // 公投结果
        if (roundEvent.vote_result) {
          detailsHtml += `
            <div class="mb-3">
              <h6>公投结果</h6>
              <p>
                <span class="badge ${roundEvent.vote_result.result === 'approved' ? 'bg-success' : 'bg-warning'}">
                  ${roundEvent.vote_result.result === 'approved' ? '通过' : '拒绝'}
                </span>
                (赞成: ${roundEvent.vote_result.approve_count})
              </p>
              <div class="table-responsive">
                <table class="table table-sm table-striped">
                  <thead>
                    <tr>
                      <th>玩家</th>
                      <th>投票</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(roundEvent.vote_result.votes).map(([pid, vote]) => `
                      <tr>
                        <td>
                          ${pid}号
                          <span class="badge ${roles[pid] && roleFactions[roles[pid]] === 'blue' ? 'bg-info' : 'bg-danger'}">
                            ${roleNames[roles[pid]] || roles[pid] || '未知角色'}
                          </span>
                        </td>
                        <td>
                          <span class="badge ${vote ? 'bg-success' : 'bg-danger'}">
                            ${vote ? '赞成' : '反对'}
                          </span>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
        
        // 任务执行结果
        if (roundEvent.mission_execution) {
          detailsHtml += `
            <div class="mb-3">
              <h6>任务执行结果</h6>
              <p>
                <span class="badge ${roundEvent.mission_execution.success ? 'bg-info' : 'bg-danger'}">
                  ${roundEvent.mission_execution.success ? '成功' : '失败'}
                </span>
                ${!roundEvent.mission_execution.success ? `(失败票: ${roundEvent.mission_execution.fail_votes})` : ''}
              </p>
            </div>
          `;
        }
        
        // 更新回合详情内容
        document.getElementById('roundDetailContent').innerHTML = detailsHtml;
        
        // 更新聊天消息
        updateChatMessages(round, roundEvent);
      }
      
      // 更新聊天消息
      function updateChatMessages(round, roundEvent) {
        const chatContainer = document.getElementById('chatMessages');
        
        if (!roundEvent.speeches || roundEvent.speeches.length === 0) {
          chatContainer.innerHTML = `
            <li class="list-group-item text-center text-muted">
              第${round}轮没有发言记录
            </li>
          `;
          return;
        }
        
        let messagesHtml = '';
        
        // 添加发言记录
        roundEvent.speeches.forEach(speech => {
          const playerId = speech[0];
          const message = speech[1];
          const playerRole = roles[playerId];
          const faction = roleFactions[playerRole] || 'unknown';
          
          messagesHtml += `
            <li class="list-group-item">
              <div class="d-flex">
                <div class="flex-shrink-0">
                  <div class="player-token player-${faction}" style="width: 30px; height: 30px;">
                    ${playerId}
                  </div>
                </div>
                <div class="flex-grow-1 ms-3">
                  <div class="d-flex justify-content-between">
                    <h6>
                      ${playerId}号玩家
                      <span class="badge ${faction === 'blue' ? 'bg-info' : 'bg-danger'}">
                        ${roleNames[playerRole] || playerRole || '未知角色'}
                      </span>
                    </h6>
                  </div>
                  <p class="mb-0">${message}</p>
                </div>
              </div>
            </li>
          `;
        });
        
        chatContainer.innerHTML = messagesHtml;
      }
      
      // 显示玩家详情
      function showPlayerDetail(playerId) {
        const playerRole = roles[playerId];
        const faction = roleFactions[playerRole] || 'unknown';
        
        // 获取玩家移动历史
        const movements = playerMovements[playerId] || [];
        
        // 生成移动历史HTML
        let movementHistoryHtml = '';
        if (movements.length > 0) {
          movementHistoryHtml = `
            <h6 class="mt-3">移动历史</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>回合</th>
                    <th>位置</th>
                    <th>移动</th>
                  </tr>
                </thead>
                <tbody>
                  ${movements.map(m => `
                    <tr>
                      <td>${m.round}</td>
                      <td>(${m.position.join(', ')})</td>
                      <td>${m.moves.join(', ') || '无移动'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
        
        // 查找该玩家所有的发言
        let speechesHtml = '';
        gameEvents.forEach(event => {
          if (event.speeches) {
            const playerSpeeches = event.speeches.filter(s => s[0] == playerId);
            if (playerSpeeches.length > 0) {
              playerSpeeches.forEach(speech => {
                speechesHtml += `
                  <div class="mb-2">
                    <span class="badge bg-secondary">第${event.round}轮</span>
                    <p class="mb-0">${speech[1]}</p>
                  </div>
                `;
              });
            }
          }
        });
        
        // 查找该玩家的投票历史
        let votingHistoryHtml = '';
        gameEvents.forEach(event => {
          if (event.vote_result && event.vote_result.votes && event.vote_result.votes[playerId] !== undefined) {
            const vote = event.vote_result.votes[playerId];
            votingHistoryHtml += `
              <tr>
                <td>${event.round}</td>
                <td>
                  <span class="badge ${vote ? 'bg-success' : 'bg-danger'}">
                    ${vote ? '赞成' : '反对'}
                  </span>
                </td>
              </tr>
            `;
          }
        });
        
        if (votingHistoryHtml) {
          votingHistoryHtml = `
            <h6 class="mt-3">投票历史</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>回合</th>
                    <th>投票</th>
                  </tr>
                </thead>
                <tbody>
                  ${votingHistoryHtml}
                </tbody>
              </table>
            </div>
          `;
        }
        
        // 更新模态框内容
        document.getElementById('playerDetailModalLabel').textContent = `${playerId}号玩家详情`;
        document.getElementById('playerDetailContent').innerHTML = `
          <div class="d-flex align-items-center mb-3">
            <div class="player-token player-${faction} me-3" style="width: 40px; height: 40px;">
              ${playerId}
            </div>
            <div>
              <h5 class="mb-0">${playerId}号玩家</h5>
              <p class="mb-0">
                <span class="badge ${faction === 'blue' ? 'bg-info' : 'bg-danger'}">
                  ${roleNames[playerRole] || playerRole || '未知角色'}
                </span>
                <span class="badge bg-secondary">${faction === 'blue' ? '蓝方' : '红方'}</span>
              </p>
            </div>
          </div>
          
          <hr>
          
          ${movementHistoryHtml}
          
          ${votingHistoryHtml}
          
          ${speechesHtml ? `
            <h6 class="mt-3">发言记录</h6>
            ${speechesHtml}
          ` : ''}
        `;
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('playerDetailModal'));
        modal.show();
      }
      
      // 初始化地图显示
      updateMap(0);
      
      // 绑定回合选择事件
      document.getElementById('roundSelector').addEventListener('change', function() {
        currentRound = parseInt(this.value);
        updateMap(currentRound);
      });
      
      // 绑定上一轮/下一轮按钮
      document.getElementById('prevRoundBtn').addEventListener('click', function() {
        if (currentRound > 0) {
          currentRound--;
          updateMap(currentRound);
        }
      });
      
      document.getElementById('nextRoundBtn').addEventListener('click', function() {
        const maxRound = Math.max(...gameEvents.map(e => e.round));
        if (currentRound < maxRound) {
          currentRound++;
          updateMap(currentRound);
        }
      });
      
      // 绑定显示移动轨迹开关
      document.getElementById('showMovementTrails').addEventListener('change', function() {
        updateMap(currentRound);
      });
    });
  </script>
{% endblock scripts %}
