{% extends "base.html" %}
{% block title %}
  游戏大厅 - 游戏平台
{% endblock title %}
{% block content %}
  <div class="container mt-5">
    <div class="row">
      <div class="col-md-8">
        <div class="card shadow mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">可用房间</h4>
            <button type="button"
                    class="btn btn-light btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#createRoomModal">
              <i class="bi bi-plus-circle"></i> 创建房间
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="roomsTable">
                <thead>
                  <tr>
                    <th>房间名称</th>
                    <th>房主</th>
                    <th>游戏类型</th>
                    <th>人数</th>
                    <th>创建时间</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% if active_rooms %}
                    {% for room in active_rooms %}
                      <tr>
                        <td>{{ room.room_name }}</td>
                        <td>{{ room.host_name }}</td>
                        <td>{{ room.game_type }}</td>
                        <td>{{ room.current_players }}/{{ room.max_players }}</td>
                        <td>{{ room.created_time }}</td>
                        <td>
                          <button class="btn btn-primary btn-sm join-room-btn"
                                  data-room-id="{{ room.room_id }}">加入</button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="6" class="text-center">当前没有可用房间，点击"创建房间"创建一个新房间吧！</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow mb-4">
          <div class="card-header bg-success text-white">
            <h4 class="mb-0">游戏信息</h4>
          </div>
          <div class="card-body">
            <p>在游戏大厅，您可以：</p>
            <ul>
              <li>查看所有可用的游戏房间</li>
              <li>创建自己的游戏房间</li>
              <li>加入其他玩家的房间</li>
            </ul>
            <hr>
            <h5>游戏类型</h5>
            <ul>
              {% for game_type in game_types %}
                <li>
                  <strong>{{ game_type.name }}</strong>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 创建房间模态框 -->
  <div class="modal fade"
       id="createRoomModal"
       tabindex="-1"
       aria-labelledby="createRoomModalLabel"
       aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="createRoomModalLabel">创建新房间</h5>
          <button type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createRoomForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
              <label for="room_name" class="form-label">房间名称</label>
              <input type="text"
                     class="form-control"
                     id="room_name"
                     name="room_name"
                     placeholder="输入房间名称">
            </div>
            <!-- 游戏类型信息（只显示不能选择） -->
            <div class="mb-3">
              <label class="form-label">游戏类型</label>
              <p class="form-control-plaintext">{{ config.games.default_type_name }}</p>
              <input type="hidden"
                     name="game_type"
                     value="{{ config.games.default_type }}">
            </div>
            <!-- 玩家人数信息（只显示不能选择） -->
            <div class="mb-3">
              <label class="form-label">玩家人数</label>
              <p class="form-control-plaintext">{{ config.games.default_players }}</p>
              <input type="hidden"
                     name="max_players"
                     value="{{ config.games.default_players }}">
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox"
                     class="form-check-input"
                     id="is_public"
                     name="is_public"
                     checked>
              <label class="form-check-label" for="is_public">公开房间</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="createRoomBtn">创建</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 加入房间状态模态框 -->
  <div class="modal fade"
       id="joinRoomModal"
       tabindex="-1"
       aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">加入房间</h5>
          <button type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">加载中...</span>
          </div>
          <p id="joinRoomStatus">正在加入房间...</p>
        </div>
      </div>
    </div>
  </div>
  <!-- JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        // 创建房间
        document.getElementById('createRoomBtn').addEventListener('click', function () {
            const formData = new FormData(document.getElementById('createRoomForm'));

            // 处理checkbox
            formData.set('is_public', document.getElementById('is_public').checked ? 'true' : 'false');

            fetch('/lobby/create_room', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.href = `/game/room/${data.room_id}`;  // 直接跳转到游戏房间
                    } else {
                        alert('创建房间失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('创建房间时发生错误');
                });
        });

        // 加入房间
        document.querySelectorAll('.join-room-btn').forEach(button => {
            button.addEventListener('click', function () {
                const roomId = this.getAttribute('data-room-id');
                const joinModal = new bootstrap.Modal(document.getElementById('joinRoomModal'));
                joinModal.show();

                fetch(`/lobby/join_room/${roomId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('joinRoomStatus').textContent = data.message;
                            setTimeout(() => {
                                // 修改这里，直接跳转到游戏房间页面
                                window.location.href = `/game/room/${roomId}`;
                            }, 1500);
                        } else {
                            document.getElementById('joinRoomStatus').textContent = '加入失败: ' + data.message;
                            setTimeout(() => {
                                joinModal.hide();
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('joinRoomStatus').textContent = '加入房间时发生错误';
                        setTimeout(() => {
                            joinModal.hide();
                        }, 2000);
                    });
            });
        });

        // 定时刷新房间列表
        setInterval(function () {
            fetch('/lobby/rooms')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 此处可以实现动态更新房间列表
                        // 为简化起见，这里不实现完整功能
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }, 30000); // 每30秒刷新一次
    });
  </script>
{% endblock content %}
