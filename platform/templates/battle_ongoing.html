{% extends "base.html" %}
{% block title %}
  对战进行中 - {{ battle.id[:8] }}...
{% endblock title %}
{% block content %}
  <div class="container mt-4">
    <!-- 略，内容保持不变 -->
  </div>
{% endblock content %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const battleId = '{{ battle.id }}';
      const statusDiv = document.getElementById('battleStatus');
      const snapshotsContainer = document.getElementById('snapshotsContainer');
      let stopped = false;

      async function fetchBattleStatus() {
        try {
          const response = await fetch(`{{ url_for('game.get_game_status', battle_id='BATTLE_ID') }}`.replace('BATTLE_ID', battleId));
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();

          if (data.success) {
            let statusText = '';
            let statusBadge = '';
            switch (data.status) {
              case 'playing':
                statusText = '进行中';
                statusBadge = 'bg-info';
                break;
              case 'waiting':
                statusText = '等待服务器启动...';
                statusBadge = 'bg-warning text-dark';
                break;
              case 'completed':
                statusText = '已完成';
                statusBadge = 'bg-success';
                stopped = true;
                statusDiv.innerHTML = `<p class="alert alert-success">对战已完成，3秒后返回大厅...</p>`;
                setTimeout(() => {
                  window.location.href = "{{ url_for('game.lobby') }}";
                }, 3000);
                return;
              case 'error':
                statusText = '发生错误';
                statusBadge = 'bg-danger';
                stopped = true;
                statusDiv.innerHTML = `<p class="alert alert-danger">对战因错误终止，3秒后返回大厅...</p>`;
                setTimeout(() => {
                  window.location.href = "{{ url_for('game.lobby') }}";
                }, 3000);
                return;
              case 'cancelled':
                statusText = '已取消';
                statusBadge = 'bg-secondary';
                stopped = true;
                statusDiv.innerHTML = `<p class="alert alert-secondary">对战已取消，3秒后返回大厅...</p>`;
                setTimeout(() => {
                  window.location.href = "{{ url_for('game.lobby') }}";
                }, 3000);
                return;
              default:
                statusText = data.status || '未知状态';
                statusBadge = 'bg-light text-dark';
            }

            statusDiv.innerHTML = `<span class="badge ${statusBadge} fs-5">${statusText}</span>`;

            if (data.snapshots && data.snapshots.length > 0) {
              const latestSnapshot = data.snapshots[data.snapshots.length - 1];
              snapshotsContainer.innerHTML = `<h6>最新快照:</h6><pre><code>${JSON.stringify(latestSnapshot, null, 2)}</code></pre>`;
            } else if (data.status === 'playing') {
              snapshotsContainer.innerHTML = '<p class="text-muted">暂无新的游戏快照...</p>';
            }

          } else {
            statusDiv.innerHTML = `<p class="text-danger">获取状态失败: ${data.message || '未知错误'}，3秒后返回大厅...</p>`;
            stopped = true;
            setTimeout(() => {
              window.location.href = "{{ url_for('game.lobby') }}";
            }, 3000);
          }

        } catch (error) {
          console.error('获取对战状态时出错:', error);
          statusDiv.innerHTML = `<p class="text-danger">获取状态时发生网络错误，3秒后返回大厅...</p>`;
          stopped = true;
          setTimeout(() => {
            window.location.href = "{{ url_for('game.lobby') }}";
          }, 3000);
        }

        if (!stopped) {
          setTimeout(fetchBattleStatus, 5000); // 继续轮询
        }
      }

      fetchBattleStatus();

      window.addEventListener('beforeunload', () => {
        stopped = true;
      });
    });
  </script>
{% endblock scripts %}
