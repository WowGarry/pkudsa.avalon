{% extends "base.html" %}
{% block title %}
  游戏房间 - {{ room_info.room_name }}
{% endblock title %}
{% block content %}
  <div class="container mt-5">
    <div class="row">
      <div class="col-lg-8">
        <div class="card shadow mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">{{ room_info.room_name }}</h4>
            <div>
              <span class="badge bg-secondary">{{ room_info.current_players }}/{{ room_info.max_players }}
              玩家</span>
            </div>
          </div>
          <div class="card-body">
            <div id="gameArea" class="mb-4">
              <div class="text-center p-5 bg-light rounded">
                {% if room_info.status == "waiting" %}
                  <h5>等待玩家加入...</h5>
                  <div class="spinner-border text-primary mt-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-3">
                    房间号: <strong>{{ room_id }}</strong>
                  </p>
                  <p>邀请朋友加入该房间!</p>
                  <!-- 添加AI代码选择区域 -->
                  <div class="mt-4 mb-3 border-top pt-3">
                    <h6>选择我的AI代码</h6>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                      <select id="myAiSelect" class="form-select" style="max-width: 240px;">
                        <option value="">正在加载AI代码...</option>
                      </select>
                      <button id="selectAiBtn" class="btn btn-outline-primary">
                        <i class="bi bi-check-circle"></i> 确认选择
                      </button>
                    </div>
                    <div id="aiStatusDisplay" class="mt-2 small text-muted">当前未选择AI代码</div>
                  </div>
                  <!-- 如果是房主，显示开始游戏按钮 -->
                  {% if is_host %}
                    <div class="mt-4 mb-3 border-top pt-3">
                      <h6>添加AI对手</h6>
                      <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
                        <select id="aiTypeSelect" class="form-select" style="max-width: 180px;">
                          <option value="">选择AI类型</option>
                          <option value="basic_player">基础AI</option>
                          <option value="smart_player">智能AI</option>
                          <option value="user_ai">用户AI代码</option>
                        </select>
                        <div id="userAiSelectContainer" style="display: none;">
                          <select id="userAiSelect" class="form-select" style="max-width: 180px;">
                            <option value="">选择用户AI</option>
                            <!-- 会通过JS动态加载 -->
                          </select>
                        </div>
                        <button id="addAiBtn" class="btn btn-outline-success">
                          <i class="bi bi-plus-circle"></i> 添加AI对手
                        </button>
                      </div>
                    </div>
                    <div class="mt-3">
                      <h6>当前参与者</h6>
                      <ul id="opponentsList" class="list-group">
                        <!-- 会通过JS动态加载 -->
                      </ul>
                    </div>
                    <div class="d-grid gap-2 mt-4">
                      <button id="startGameBtn" class="btn btn-primary">
                        <i class="bi bi-play-fill"></i> 开始游戏
                      </button>
                    </div>
                  {% endif %}
                {% elif room_info.status == "playing" %}
                  <div id="gameContent">
                    <!-- 游戏内容将在这里动态加载 -->
                    <h5>游戏正在进行!</h5>
                    <!-- 可以添加游戏界面或状态信息 -->
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 操作按钮 -->
      <div class="mt-3 text-center">
        <button type="button" class="btn btn-danger" id="leaveRoomBtn">
          <i class="bi bi-box-arrow-left"></i> 离开房间
        </button>
      </div>
    </div>
  </div>
  <!-- 添加游戏结果模态框 -->
  <div class="modal fade"
       id="gameResultModal"
       tabindex="-1"
       aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">游戏结果</h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body" id="gameResultContent">
          <!-- 结果内容将在这里动态加载 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <a href="/lobby" class="btn btn-primary">返回大厅</a>
        </div>
      </div>
    </div>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const roomId = "{{ room_id }}";
    const userId = "{{ current_user.id }}";
    const isHost = {{ 'true' if room_info.host_id| int == current_user.id | int else 'false'
  }};

  // 离开房间
  document.getElementById('leaveRoomBtn').addEventListener('click', function () {
    // 保留原有的离开房间逻辑...
  });

  // 开始游戏（仅房主可见）
  const startGameBtn = document.getElementById('startGameBtn');
  if (startGameBtn) {
    startGameBtn.addEventListener('click', function () {
      // 保留原有的开始游戏逻辑...
    });
  }

  // =================== AI代码选择功能 ===================

  // 加载用户的AI代码列表
  function loadUserAiCodes() {
    fetch(`/game/available_ai_codes`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const myAiSelect = document.getElementById('myAiSelect');
          myAiSelect.innerHTML = '<option value="">选择AI代码...</option>';
          
          // 使用修改后的数据结构
          data.ai_codes.user_ai.forEach(ai => {
            const option = document.createElement('option');
            option.value = ai.id;
            option.textContent = ai.name;
            myAiSelect.appendChild(option);
          });
        }
      })
      .catch(error => {
        console.error('加载AI代码失败:', error);
      });
  }

  // 更新AI状态显示
  function updateAiStatusDisplay(ai) {
    const statusEl = document.getElementById('aiStatusDisplay');
    if (ai) {
      statusEl.innerHTML = `当前选择: <strong>${ai.name}</strong> (${ai.is_active ? '活跃' : '未活跃'})`;
      statusEl.className = 'mt-2 small text-success';
    } else {
      statusEl.innerHTML = '当前未选择AI代码';
      statusEl.className = 'mt-2 small text-muted';
    }
  }

  // 选择AI代码按钮事件
  document.getElementById('selectAiBtn')?.addEventListener('click', function () {
    const aiId = document.getElementById('myAiSelect').value;
    if (!aiId) {
      alert('请选择一个AI代码');
      return;
    }

    // 先选择AI
    fetch(`/select_ai/${roomId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({ ai_id: aiId })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 选择成功后，实例化AI
          return fetch(`/ai/api/instantiate_player/${aiId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ room_id: roomId })
          });
        } else {
          throw new Error(data.message);
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('AI代码实例化成功！您的AI已准备就绪');
          updateAiStatusDisplay({
            name: document.getElementById('myAiSelect').options[
              document.getElementById('myAiSelect').selectedIndex
            ].text,
            is_active: true,
            instance_id: data.instance_id
          });
        } else {
          alert('AI实例化失败: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('选择AI失败: ' + error.message);
      });
  });

  // 页面加载时加载AI代码列表
  if (document.getElementById('myAiSelect')) {
    loadUserAiCodes();
  }

  // =================== AI对手添加功能 ===================

  // AI类型选择变化时的处理
  const aiTypeSelect = document.getElementById('aiTypeSelect');
  if (aiTypeSelect) {
    aiTypeSelect.addEventListener('change', function () {
      const userAiContainer = document.getElementById('userAiSelectContainer');
      if (this.value === 'user_ai') {
        userAiContainer.style.display = 'block';
        loadAvailableUserAis();
      } else {
        userAiContainer.style.display = 'none';
      }
    });
  }

  // 加载可用的用户AI代码
  function loadAvailableUserAis() {
    fetch('/user/api/user_ai_codes')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const userAiSelect = document.getElementById('userAiSelect');
          userAiSelect.innerHTML = '<option value="">选择用户AI</option>';

          // 添加用户AI选项
          data.ai_codes.user_ai.forEach(ai => {
            const option = document.createElement('option');
            option.value = ai.id;
            option.textContent = ai.name;
            userAiSelect.appendChild(option);
          });

          if (data.ai_codes.user_ai.length === 0) {
            userAiSelect.innerHTML = '<option value="">没有可用的用户AI</option>';
          }
        }
      })
      .catch(error => {
        console.error('加载AI代码失败:', error);
        document.getElementById('myAiSelect').innerHTML = '<option value="">加载失败</option>';
      });
  }

  // 添加AI对手按钮
  const addAiBtn = document.getElementById('addAiBtn');
  if (addAiBtn) {
    addAiBtn.addEventListener('click', function () {
      const aiType = document.getElementById('aiTypeSelect').value;
      if (!aiType) {
        alert('请选择AI类型');
        return;
      }

      let aiCodeId = null;
      if (aiType === 'user_ai') {
        aiCodeId = document.getElementById('userAiSelect').value;
        if (!aiCodeId) {
          alert('请选择一个用户AI代码');
          return;
        }
      }

      // 从表单或隐藏字段获取令牌
      const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

      fetch(`/game/add_ai_opponent/${roomId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken || ''  // 使用获取到的令牌，如果没有则使用空字符串
        },
        body: JSON.stringify({
          ai_type: aiType,
          ai_code_id: aiCodeId
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateOpponentsList();
          } else {
            alert('添加AI对手失败: ' + data.message);
          }
        })
        .catch(error => {
          console.error('添加AI对手失败:', error);
          alert('添加AI对手失败，请重试');
        });
    });
  }

  // 更新对手列表
  function updateOpponentsList() {
    fetch(`/game/opponents/${roomId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const opponentsList = document.getElementById('opponentsList');
          if (opponentsList) {
            opponentsList.innerHTML = '';

            data.opponents.forEach(opponent => {
              const li = document.createElement('li');
              li.className = 'list-group-item d-flex justify-content-between align-items-center';

              let opponentText = '';
              if (opponent.is_ai) {
                opponentText = `AI: ${opponent.ai_name || '未命名AI'}`;
              } else {
                opponentText = `玩家: ${opponent.username || '未知玩家'}`;
              }

              li.innerHTML = `
                                  ${opponentText}
                                  ${isHost ? `<button class="btn btn-sm btn-danger remove-opponent" data-id="${opponent.is_ai ? opponent.ai_id : opponent.user_id}" data-type="${opponent.is_ai ? 'ai' : 'human'}">移除</button>` : ''}
                              `;
              opponentsList.appendChild(li);
            });

            // 添加移除对手事件
            document.querySelectorAll('.remove-opponent').forEach(btn => {
              btn.addEventListener('click', function () {
                removeOpponent(this.dataset.id, this.dataset.type);
              });
            });
          }
        }
      })
      .catch(error => {
        console.error('获取对手列表失败:', error);
      });
  }

  // 移除对手
  function removeOpponent(id, type) {
    fetch(`/game/remove_opponent/${roomId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({ id: id, type: type })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateOpponentsList();
        } else {
          alert('移除对手失败: ' + data.message);
        }
      })
      .catch(error => {
        console.error('移除对手失败:', error);
        alert('移除对手失败，请重试');
      });
  }

  // 页面加载时更新对手列表
  if (document.getElementById('opponentsList')) {
    updateOpponentsList();
  }

  // =================== 游戏状态监控 ===================

  // 定时获取游戏状态
  let gameStatusInterval;

  if ("{{ room_info.status }}" === 'playing') {
    gameStatusInterval = setInterval(fetchGameStatus, 2000);
  }

  function fetchGameStatus() {
    const battleId = '{{ room_info.battle_id }}';
    if (!battleId) return;

    console.log(`尝试获取游戏状态，battleId: ${battleId}`);
    fetch(`/game/status/${battleId}`)
      .then(response => {
        if (!response.ok) {
          console.error(`获取游戏状态请求失败: ${response.status} ${response.statusText}`);
          throw new Error(`HTTP错误! 状态: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('获取游戏状态成功:', data);
        if (data.success) {
          updateGameUI(data.status, data.snapshots, data.result);

          // 如果游戏已结束，停止轮询
          if (data.status === 'completed' || data.status === 'error') {
            clearInterval(gameStatusInterval);
            // 显示游戏结果模态框
            showGameResultModal(data.result);
          }
        }
      })
      .catch(error => {
        console.error('获取游戏状态失败:', error);
      });
  }

  function updateGameUI(status, snapshots, result) {
    // 更新游戏UI的逻辑...
    const gameContent = document.getElementById('gameContent');
    if (!gameContent) return;

    if (status === 'completed') {
      gameContent.innerHTML = '<h5>游戏已结束!</h5>';
    } else if (status === 'error') {
      gameContent.innerHTML = '<h5 class="text-danger">游戏发生错误!</h5>';
    }

    // 处理快照更新UI
    if (snapshots && snapshots.length > 0) {
      const eventsDiv = document.createElement('div');
      eventsDiv.className = 'mt-3';

      const latestSnapshots = snapshots.slice(-5); // 最新的5个事件
      latestSnapshots.forEach(snapshot => {
        const eventP = document.createElement('p');
        eventP.className = 'small mb-1';
        eventP.textContent = `${snapshot.event_type}: ${snapshot.description}`;
        eventsDiv.appendChild(eventP);
      });

      // 更新或追加事件区域
      const existingEvents = document.getElementById('gameEvents');
      if (existingEvents) {
        existingEvents.innerHTML = eventsDiv.innerHTML;
      } else {
        eventsDiv.id = 'gameEvents';
        gameContent.appendChild(eventsDiv);
      }
    }
  }

  function showGameResultModal(result) {
    if (!result) return;

    const gameResultContent = document.getElementById('gameResultContent');
    let resultHTML = '<h5>游戏结果</h5>';

    if (typeof result === 'string') {
      resultHTML += `<p>${result}</p>`;
    } else {
      // 格式化结果对象
      if (result.winner) {
        resultHTML += `<p>获胜阵营: ${result.winner === 'blue' ? '蓝方' : '红方'}</p>`;
      }

      if (result.winning_reason) {
        resultHTML += `<p>获胜原因: ${result.winning_reason}</p>`;
      }
    }

    gameResultContent.innerHTML = resultHTML;
    const gameResultModal = new bootstrap.Modal(document.getElementById('gameResultModal'));
    gameResultModal.show();
  }
      });
  </script>
{% endblock content %}
