# 《图灵阿瓦隆》七人局天梯 ELO 机制说明

（此文档既面向用户，也面向开发者）

---

## **一、基础规则**

1. **游戏胜负**

  - 蓝方（4人）需要完成3次任务成功
  - 红方（3人）需要破坏3次任务或刺杀梅林
  - **最终胜负只有一方胜利**（无平局，除非游戏意外中止触发惩罚）

2. **ELO天梯**

  - 按照 ELO 机制，《图灵阿瓦隆》游戏平台中显示的 `分数` 即某位玩家的 **ELO 分数** 。
  - 当用户注册之后，其**自动被赋予 1200 分的初始 ELO 积分**，并开始参与 ELO 天梯排名。
  - 参与对战游戏，平台主要根据游戏胜负增加/减少您的 ELO 分数（详情见后文）。
  - 踊跃参与对战，积极优化代码，努力成为大师，努力成为金字塔的塔尖！

---

## **二、ELO分数计算机制**

### 1. **基础公式**

所有玩家根据**胜负结果**调整分数：

$\Delta ELO = K \times (结果 - 预期胜率)$

- **结果**：胜利为 `1` ，失败为 `0`
- **预期胜率**：根据双方队伍平均ELO计算（公式见下文）
- ***K* 值**：32

### 2. **改进版的ELO评分**

我们将使用改进版的ELO评分系统，结合了队伍表现和个体资源贡献。以下是核心公式的解析：

1. **队伍调和平均ELO计算**

   $\text{队伍平均} = \frac{\text{队员数}}{\sum_{i=1}^{n} \min\left(1,\ \frac{1}{\text{ELO}_i}\right)}$

   其中`队员数`为队伍人数，通过调和平均降低低分玩家对队伍评分的影响。

2. **基础预期胜率**

   $E_{\text{基础}} = \frac{1}{1 + 10^{(\text{队伍平均}_\text{对手} - \text{队伍平均}_\text{己方})/400}}$

   基于队伍调和平均分差的标准ELO预期胜率计算。

3. **资源贡献修正系数**

   $\alpha = 0.9 + \frac{\max\left(\frac{\text{输入} + 3 \times \text{输出}}{\text{平均资源}} - 1,\ 0\right)}{3}$

   通过LLM的输入token和3倍输出token计算资源占比，对超过平均值的部分给予0.9~1.2的修正区间。

4. **调整后预期胜率**

   $E_{\text{调整后}} = \min(1,\ E_{\text{基础}} \times \alpha)$

   结合资源贡献系数调整后的最终预期胜率。

5. **ELO更新公式**

   $\Delta\text{ELO} = K \times (S_{\text{实际}} - E_{\text{调整后}})$

   其中 $K=32$ ，实际结果 $S∈{0,1}$ ，最终ELO最低保底100分。

该公式在传统ELO机制上增加了两个关键改进：

- 使用调和平均弱化低水平队友的影响
- 通过资源消耗系数动态调整预期胜率，鼓励合理分配计算资源

### 3. **犯规惩罚**

若一局中出现某位玩家代码报错或输出信息不合理等犯规行为，**游戏立即结束，进行犯规处理**：

**处理方式**：  

1. **扣除犯规玩家 50 分**
2. 本局判定为**平局**，其他玩家ELO不变

---

## **四、计算示例**

### 场景描述

- **蓝方**平均ELO 1500，**红方**平均ELO 1550

### 计算步骤

1. **预期胜率**：

  $预期胜率_{\text{蓝方}} = \frac{1}{1 + 10^{(1550-1500)/400}} \approx 0.45$

2. **加/减分**：

  $\Delta ELO = 20 \times (1 - 0.45) = 20 \times 0.55 = +11$

  四舍五入后，该玩家最终ELO**增加**11分。

  \* 对于失败的玩家， $\Delta ELO < 0$ ，该玩家最终遭到减分。

---

> **📢欢迎就 ELO 机制的细节进行讨论（即使您不在技术组中）**！请把观点或问题加到 [Issue](https://github.com/pkulab409/pkudsa.avalon/issues/10) 中。