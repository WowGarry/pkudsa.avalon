# 《图灵阿瓦隆》七人局天梯 ELO 机制说明

（此文档既面向用户，也面向开发者）

---

## **一、基础规则**

1. **游戏胜负**

  - 蓝方（4人）需要完成3次任务成功
  - 红方（3人）需要破坏3次任务或刺杀梅林
  - **最终胜负只有一方胜利**（无平局，除非游戏意外中止触发惩罚）

2. **ELO天梯**

  - 按照 ELO 机制，《图灵阿瓦隆》游戏平台中显示的 `Points` 即某位玩家的 **ELO 分数** 。
  - 当用户注册之后，其**自动被赋予 1000 分的初始 ELO 积分**，并开始参与 ELO 天梯排名。
  - 参与对战游戏，平台主要根据游戏胜负增加/减少您的 ELO 分数（详情见后文）。
  - ELO 分数将分为三个区间：

    | 玩家分段    | ELO区间       |
    |-------------|---------------|
    | 新手区      | 0~1499        |
    | 进阶区      | 1500~1799     |
    | 大师区      | 1800~         |

  - 踊跃参与对战，积极优化代码，努力成为大师，努力成为金字塔的塔尖！

> 🚧给开发者：若要修改ELO区间，则需要同步修改：  
> 
> [user_tab.py](/platform/ui/components/user_tab.py)  
> 
> [user_service.py](/platform/services/user_service.py)

---

## **二、ELO分数计算机制**

### 1. **基础公式**

所有玩家根据**胜负结果**和**个人表现**调整分数：

$$
\Delta ELO = K \times (结果 - 预期胜率) \times (1 + 行为评分)
$$

- **结果**：胜利为 `1` ，失败为 `0`
- **预期胜率**：根据双方队伍平均ELO计算（公式见下文）
- **行为评分**：根据玩家表现，范围 `0~0.09`（后文解释）
- ***K* 值**：分段调整（见下表）

| 玩家分段    | ELO区间       | K值  | 说明               |
|-------------|---------------|------|--------------------|
| 新手区      | 0~1499        | 40   | 鼓励快速爬分       |
| 进阶区      | 1500~1799     | 30   | 平衡稳定性与变化   |
| 大师区      | 1800~         | 15   | 减少高分波动       |

### 2. **预期胜率计算**

根据队伍平均ELO预测胜负概率：

$$
预期胜率_{\text{蓝方}} = \frac{1}{1 + 10^{(E_{\text{红方}} - E_{\text{蓝方}})/400}}
$$

- $E_{\text{蓝方}}$：蓝方队伍平均ELO
- $E_{\text{红方}}$：红方队伍平均ELO

### 3. **行为评分**

仅计算玩家对阵营目标的直接贡献： （**🚧仅做示例，若不合理，后期调整**）

  - **蓝方玩家**：每参与到一轮的任务执行者队伍中，完成1次任务，且最终胜利，行为评分+0.03（最高+0.09）
  - **红方玩家**：每参与到一轮的任务执行者队伍中，破坏1次任务，且最终胜利，行为评分+0.03（最高+0.09）

**示例**：
  - 某蓝方玩家参与到队伍中完成2次任务且最终胜利 → 行为评分=0.06
  - 某红方玩家参与到队伍中破坏1次任务且最终胜利 → 行为评分=0.03

> **🚧未来扩展计划**：角色权重，即可能为梅林、刺客等关键角色设计额外分数系数；其他保证游戏公平的更多行为指标评分。

---

## **三、匹配与惩罚机制**

### 1. **阵营平衡**

匹配时强制要求：

$$
|E_{\text{蓝方}} - E_{\text{红方}}| < 100
$$

确保双方实力接近，避免“一边倒”对局。

### 2. **犯规惩罚**

若一局中出现某位玩家超token等犯规行为，**游戏立即结束，进行犯规处理**：

**处理方式**：  

1. 扣除犯规玩家 $|E_{\text{蓝方}} - E_{\text{红方}}| \times 2$ 分数
2. 本局判定为**平局**，其他玩家ELO不变

---

## **四、计算示例**

### 场景描述

- **蓝方**平均ELO 1500，**红方**平均ELO 1550
- 蓝方胜利，某蓝方玩家（ELO 1600，分段：进阶区）参队完成2次任务

### 计算步骤

1. **预期胜率**：

  $$
  预期胜率_{\text{蓝方}} = \frac{1}{1 + 10^{(1550-1500)/400}} \approx 45\%
  $$

2. **行为评分**：
  参队完成2次任务 → +0.06

3. **加/减分**：

  $$
  \Delta ELO = 20 \times (1 - 0.45) \times (1 + 0.06) = 20 \times 0.55 \times 1.06 = +11.66
  $$

  四舍五入后，该玩家最终ELO**增加**12分。

  \* 对于失败的玩家， $\Delta ELO < 0$ ，该玩家最终遭到减分。

---

> **📢欢迎就 ELO 机制的细节进行讨论（即使您不在技术组中）**！请把观点或问题加到 [Issue](https://github.com/pkulab409/pkudsa.avalon/issues/10) 中。
